require 'pp'

INPUT = <<~TEXT.split("\n")
Tile 3571:
##..##....
..##..#..#
#...##....
.....#...#
..........
...###....
#......##.
#...#...#.
#...##...#
#.####.##.

Tile 2687:
#..##..###
..........
.....##..#
.#.#..##.#
#.#..#..##
#.....#...
#...#.....
##....##..
#...#...##
..#.#.#.##

Tile 3049:
##.#.#.###
....##.###
....##....
#.........
#.#...#..#
#..##....#
#.#......#
#..#..##..
#......###
#.#..#...#

Tile 1597:
###..##...
##.....###
.#..#..#.#
#.......#.
#.#.......
.#..#.....
#.....#...
#........#
##.#...##.
.....#.###

Tile 1301:
#.##.#.###
#........#
....#.....
#.....####
.#....#.##
.....#....
#..##..#.#
.....#..##
.#.##..#.#
#...######

Tile 3259:
..#####.#.
.....#...#
#...#.....
...##...#.
.#..#..##.
.#.......#
........##
#.......#.
.#.#...#..
#...#.#..#

Tile 3989:
#..#..####
..........
#........#
.#....#...
..........
#.........
.#........
#........#
...##.####
.######.##

Tile 3803:
#.####...#
.###.#..#.
....##..#.
#........#
..##..#...
####.#....
..#...#...
#..#.....#
..##....#.
#....#...#

Tile 2897:
.#..##.#.#
..#.#...##
#........#
###.#..#.#
...#..#.##
...#....##
....##...#
.....##..#
.#....#...
..##....##

Tile 2843:
##.###..##
#.#.......
#....#....
#..##.##..
.##..#.##.
#....#....
#.#...#.##
..........
.#...#...#
###..#..##

Tile 3023:
.#..###.#.
.........#
..........
.#........
#.#....#.#
....#...#.
#.......#.
##.#.....#
..#...#..#
.....####.

Tile 2887:
#....##...
#...#.....
##...##...
#.....##.#
.......#..
#......#.#
..##..#..#
....#....#
#.###.....
#.####..#.

Tile 1013:
#..####.#.
#.##...#.#
#..#..#...
#..#..#..#
...#......
#.####...#
.#..##..##
...#.#..##
....##..##
#.##.#.#.#

Tile 3733:
###.##.#.#
..#....#..
#...#.#..#
....###..#
.#........
.....#....
........##
##........
#........#
#.#...#..#

Tile 3691:
.##...####
##..##....
#.#.##..##
#........#
#.....##.#
.....#....
##.#.....#
#..#.....#
..#.......
####....#.

Tile 3061:
##.....#..
.....#...#
....##...#
###.#.....
#..#..###.
#.#.###..#
..#......#
#..#.#...#
..#.......
..#.#..#..

Tile 1489:
###.......
.....##...
..#...##..
#.....#...
#.#......#
##.#..####
...##.#...
...#...#.#
..........
.##.##.#.#

Tile 1637:
#########.
.#.....#..
#........#
#........#
.##.....##
.........#
#....#..##
#.....####
...###...#
.#..##..##

Tile 1069:
#.#...####
##...#...#
.....#...#
.......##.
......#..#
#........#
#...#.....
......#...
#.#..#....
####.##.#.

Tile 1039:
#..#######
###.......
.....#....
#.........
....#....#
...####...
.#...##...
#.#....#.#
........##
#.#..#..#.

Tile 2767:
.#.#..#.##
.#..#....#
#..#.#....
#.#..##..#
.####.#.##
#....##...
....##..##
###.....#.
..........
....#.###.

Tile 2957:
####.#####
.......##.
...#.....#
...##..##.
...##.##..
#..#..#..#
.....#....
#..#....#.
.##.......
.##..#.##.

Tile 2789:
.##..#.#.#
#.#.....##
#....#...#
#....##...
..#..#....
#.........
#.#..#..##
#........#
.#.......#
#####...##

Tile 2837:
.....#...#
.....#.#.#
#.......#.
#...#...#.
..#.....#.
..#.#..#..
##.......#
....#....#
#...#.....
##.###....

Tile 3251:
.######...
...#......
.#.#..###.
#..#.##..#
###.#....#
#.#......#
..#..###..
##.#..#..#
...#...###
##.#..##..

Tile 3137:
#####.#..#
#.#..#.##.
#.#..#....
#.........
.........#
.........#
...#......
#...#...#.
....#..#.#
.#.###.#.#

Tile 3433:
.##..####.
...#......
#..##....#
....#....#
#..###....
..#......#
.#..###...
.##.#.....
.........#
.....#....

Tile 2551:
#.########
#.#.......
##..#...##
#.#..###.#
#........#
.#.#....#.
#........#
.##....#..
#........#
##..##.#..

Tile 2647:
..####..##
##....#..#
#.........
###.#.....
#......#..
....#...##
.#..##.#.#
.#.#..#...
.....##.##
.#.#...#..

Tile 1087:
#..###..##
#...#.#.#.
.......#..
..#.#.#..#
#.......#.
#....#....
....#....#
##...##..#
#..#......
.#..#.###.

Tile 1423:
..#....#.#
#........#
.#.##.##..
#.###.#.#.
#.#......#
...##...##
#....#....
....#....#
.........#
#####....#

Tile 1759:
..#.#..#..
##...#...#
....#..#..
#....#....
.##..##..#
...#.#...#
#..#.....#
##.......#
......#..#
#.##......

Tile 1583:
.###.####.
......###.
......#..#
.#...##...
#...#....#
..#.##....
#...##..#.
......#...
#.....###.
####.#....

Tile 1171:
###......#
#...##...#
#####..##.
#.......#.
#.#...#..#
#....#....
....#....#
##.....#.#
#.#..#..##
#.#.#..##.

Tile 2801:
.###.####.
......#...
##..##.#.#
.....#....
#......#..
###..##..#
##.#..##.#
#..#..#...
#..#.#...#
#..###.###

Tile 1559:
.##..#...#
#.##..#...
...##..#..
..#.#.....
...#...#..
.........#
...#.....#
#..##.#..#
##..##....
...###...#

Tile 2609:
##.#..####
..........
#........#
##.###...#
#.#..#....
..#..##..#
#....#.#.#
#.#.......
#....#...#
#.####.#.#

Tile 2287:
#......#.#
.....#.#.#
..#..#...#
##.#..#...
..#..#.###
.......###
#......##.
#.##.##...
......#..#
#####.##.#

Tile 3659:
.###.#####
#.#.......
..........
..#.....##
#..#......
#.#.#...##
#.........
.#...#....
##.....#..
#####.##.#

Tile 3539:
.......#.#
..##...#..
.....#.#.#
##.#......
####......
...#..#...
#.......##
#...#.....
#..#.....#
.##.#....#

Tile 3121:
..##.#...#
.###..#...
##.#.#....
#.....#..#
#.#.......
#.........
....#...##
......###.
#........#
#..###..##

Tile 2237:
...##.....
..........
...#......
#....#...#
#.........
.......#..
#...###..#
.....#...#
.........#
#.####.##.

Tile 1277:
.###...##.
.......###
#.....##..
#.##..###.
#.#..#....
.....#....
#...#....#
#.#......#
#...###..#
...##...##

Tile 2161:
..#####..#
#....##..#
#.....#..#
....#....#
.....#.##.
..........
#......#.#
#..#......
#....#..##
.##.....#.

Tile 3709:
.#..#...##
#..#.....#
...#....#.
..........
.#...#....
..........
....##....
#.........
.........#
..####....

Tile 1117:
##.##.#..#
.....##...
.#.#..#.##
.#...#..#.
#.##.#....
####.....#
##..#.....
#.........
#...##...#
####..#.#.

Tile 2081:
##.##.###.
#...#.....
#.....#...
#.#..#.#..
#.....#..#
...#.....#
#....#....
......#..#
.#.##..#..
###..#.#.#

Tile 1709:
##...#.##.
###..#....
#.......#.
#.....##..
.........#
#....#..##
..#...##..
#...#.....
#...#.#..#
.###.#....

Tile 2927:
...###..##
##.#......
..........
##........
#....#...#
.......##.
#.....#..#
##.#.#....
#......#..
...#.####.

Tile 1499:
#....##.#.
......#...
#........#
......#...
.#.......#
#.#...#.##
..#....#.#
#...#.....
.........#
#.....##.#

Tile 1453:
#.##.####.
..#...##..
.........#
.........#
#..#..#...
.........#
#....#.#..
#.....#..#
.#........
#....#....

Tile 1283:
.#.##..###
..#...#.#.
...##..#..
#.......#.
#......#..
#..##.....
#.......##
....##...#
..#.....##
##.#.#...#

Tile 2063:
......#.##
.........#
....##..#.
.#....##..
##........
.###.###.#
#.#....#..
....#...#.
#......###
#....####.

Tile 3529:
...###.##.
#....#...#
...#.....#
...#.#..#.
.#.#.....#
#...#.....
##..#..#..
#.....#..#
.#........
.#..#####.

Tile 2657:
..#.##..#.
##..#...##
#.....#...
#....##...
.....#..##
#.#..##.##
#.........
#.#...##.#
##....#...
##..####.#

Tile 2089:
.#########
##.#.##..#
#........#
#..###..##
...#......
##..#....#
#...#..#..
#..#....#.
..#.#....#
...###...#

Tile 3779:
#.#...##.#
.##...##..
.....##...
.#....##.#
###..##..#
#.#..#.#..
....##...#
##...#....
.#...#....
#######...

Tile 3217:
...##.....
....##....
.....##..#
##...#.#.#
###.......
...#...#..
...#.....#
#..#.#.###
##.#...#.#
.#.#..##..

Tile 3907:
..#..##.##
#.#.....##
#.......#.
.#...###..
..###.####
##.#..##..
#.........
##...#..#.
#....#....
.#.....#.#

Tile 3547:
#..#.##...
#..###...#
##.......#
.....#....
#...#...#.
#..#..#...
........#.
......##.#
.......#..
.##.#..##.

Tile 3187:
##.#.##...
#...#.##.#
#...#.....
#....#..##
....#.#..#
.....#....
.....#..##
....##...#
..........
#######.##

Tile 1217:
##.#####..
#.......#.
...#....##
#........#
#.#......#
.....#...#
#.........
....#...##
#...#.....
.#...###.#

Tile 3821:
#.###.###.
#.#......#
#..#.#...#
.##...#.##
...#....##
#...#..##.
#......#.#
###..#...#
.........#
#....##.##

Tile 1607:
##..#..##.
#.##....##
###.##.##.
.#....##.#
#.#..#...#
.....#.#..
#.#..#..#.
#.#..#....
..........
......##.#

Tile 1459:
.###.##..#
#.......#.
##........
..#...####
###.......
#....#....
.#.....#.#
###..#..##
.....#....
..#..#..##

Tile 2129:
....#.#..#
#.....##.#
#........#
..........
..#......#
#.....#..#
.#..##...#
#.#.#..#.#
#.........
#.##....##

Tile 1601:
.#.#.#.#.#
..#..##...
#.#.#...#.
....##....
....##.#..
..#.......
#.....#..#
#..##.#...
.........#
...####.#.

Tile 1801:
#.#...#.#.
..#....#..
#..#...#..
......#...
.....#....
#.#..##.##
#.........
...#.#...#
.#....#..#
#.....##..

Tile 2447:
..#.....##
.#..#...##
.....#.#..
.#....#..#
#...####.#
##.##..###
.#.......#
#.##.....#
#.......##
.###.#...#

Tile 2203:
#.....##..
#.#.......
........##
###...#...
..........
#..#.....#
....#.##.#
..##.....#
.#...#...#
#.###..#..

Tile 1381:
.#...#...#
....#.....
##.......#
#.....#...
.........#
.#.......#
.......##.
#.#.....##
.#..#.##..
##.#.##.#.

Tile 3163:
#...####.#
#......##.
...###.#.#
#....##...
#......###
.....#..##
.#..###...
#..##..#..
#.....#...
#.#####.##

Tile 3673:
.#....##.#
..#..####.
#.....#...
...#....#.
#....#...#
#....##.#.
##...#.#..
.#..#.#...
#..#.....#
####.##...

Tile 3919:
....##.##.
##..##....
...##...##
#...#.....
..........
....#..###
.#.....#..
....#..#.#
.##..#....
.#...###.#

Tile 2437:
..##...#.#
#....#...#
#..#.....#
..#.#...##
.......#..
........##
........##
.......#.#
#....#.#.#
##..#.###.

Tile 2969:
##.#.##.#.
#.##....#.
.##......#
#.#.#....#
#.#.......
.........#
....#.#.##
.#.......#
...#..#.##
##.#.##..#

Tile 2621:
.##.##.#..
.##...#...
..........
#.........
#.#.#.#..#
..#..#...#
.......#.#
#.#.....##
...#..#...
#.......##

Tile 3613:
##..#....#
#..##.....
..#.......
..#...#...
...#...#..
...#.....#
..#.....#.
..#.###..#
..........
..#.####..

Tile 2777:
##.#####.#
#.##.#...#
..#.......
.##...##.#
.........#
.#.###.##.
#......##.
#......##.
#...##..##
#..#....##

Tile 2711:
#..#..##..
..........
#.#......#
#.....####
..........
##.......#
........#.
#.......#.
#.#..#...#
#.#.####.#

Tile 2281:
.#.###...#
###....#..
..........
#.#..#..##
.........#
###..#.##.
####..#..#
##..#.....
##..#..#..
#.....#..#

Tile 1579:
....#..#..
#........#
#...#..#..
..##.#.#..
.###.#...#
....##..#.
...##.#...
.#.##....#
.#.......#
##...#...#

Tile 2411:
#.#....##.
..#...#..#
.#..##....
.#..##...#
.....#.#.#
......##..
#.#....###
.#.##....#
..#..#....
..#.###..#

Tile 2963:
.......##.
.....#....
.........#
#.....#..#
.....#.#..
.....#.##.
.#.#...###
#.#.......
.#.......#
###..#..#.

Tile 1693:
#.##..##..
..........
.........#
.##..#...#
.........#
#........#
###......#
..#...#...
.#.##....#
...#.#...#

Tile 2399:
###.#.##..
#...#.....
...#...#.#
###.......
.##.##....
##.....#.#
####......
##.......#
#..#...#.#
#...#.....

Tile 1913:
##.....###
........##
#.....###.
..........
....#...#.
#.#.....#.
#....#...#
..#...#...
....#..#..
#..####...

Tile 3343:
.....#.##.
..#...#...
####.....#
....#.....
......#..#
......#...
#........#
#.......#.
..#...#.#.
.....###.#

Tile 2557:
#.......##
....#...##
#......#.#
#.#.#.#.##
#..##.....
..###.#.#.
#..#......
#...#.....
....#....#
#.##...#.#

Tile 1097:
.#.#.#..##
..#.#.....
##........
.##...##..
..#..#...#
#........#
........##
#.#.#.....
.#.#.....#
#.##..#...

Tile 2591:
##..#..###
......#...
...###.#..
#.......#.
#.#.....#.
#.##..#...
....##.#..
#.#..#...#
#.###..#.#
##........

Tile 3413:
...##...##
..#....#..
##.#....#.
#..#....#.
#........#
#..#......
#.....#.##
##.....#.#
#....#....
####.#...#

Tile 2087:
###..###.#
##......#.
#..#...#.#
#.#.......
##.#.....#
#.#.#.....
...#.....#
..........
#.........
#.##..###.

Tile 3037:
......##..
..#..#....
#.#.......
#.#....#..
.#.#.##..#
#.....#.##
#.....#.#.
.#..##...#
#....##...
...#..###.

Tile 2239:
.####..#..
#.........
.#.......#
#..##.....
##..##..##
#.#....#..
.........#
#.......#.
....#.....
#.###..#.#

Tile 3313:
##.##.#..#
.#.#..#...
.##...##.#
.#.##..#..
##........
..........
#..#.#....
#.........
..........
.##..#..#.

Tile 3361:
.###.#...#
##..#.#..#
...##....#
#..##.....
..........
#......#.#
.........#
..#..##.#.
#..#...###
#...#.#.#.

Tile 3167:
..##..####
#.....#.#.
.....#.#..
...#......
....#.#.##
...#.#.#..
.......#..
##........
#..#...#.#
####.##..#

Tile 1979:
#.#.###...
..#.....##
...#...##.
#.......##
........##
..##..#...
..#......#
#.#....#.#
#..#.....#
.##.......

Tile 1831:
##.##.##.#
#.........
.........#
##.......#
###.....##
..##..##..
##.....#.#
#....#...#
###.##..#.
#..#####..

Tile 1487:
#..#....##
.#..#....#
#....#....
#.........
#.#...#.##
#..##...##
...##..#..
.#...##...
.#........
.#...#..#.

Tile 1987:
###..#....
##..##...#
......#..#
.#.#...#.#
.....#.#..
....#..#..
....###..#
#...##....
###.....#.
...##.####

Tile 3083:
....##..#.
##..#.###.
#..#...##.
#.###.....
.........#
....#.....
.#........
.#........
#.........
#.#.#.##.#

Tile 1543:
...##..###
.........#
.......#.#
#..#..#.##
##....#.#.
....#..#..
#..#......
...#...#.#
##.##..#..
#.###..#..

Tile 1151:
#.#..#####
#.#..#...#
#..#......
....#...#.
..........
#...#.#..#
#..#.#...#
##....#..#
#.........
##.....###

Tile 1009:
##..#...##
#....#...#
.#...#....
#........#
.#..#..#..
.###.##.#.
#......#.#
##.#..##..
#....#.###
####...##.

Tile 3929:
......#.#.
#..#.##.##
....#.#.##
#.##..#...
###..#..#.
.##..###.#
.##......#
....#....#
........#.
.#...###..

Tile 1321:
#.##..#...
.##.....##
#.#..#....
...#.....#
###......#
#.#.#.##.#
##.......#
##......#.
.#...#....
.#..##..##

Tile 2017:
###.#..###
.#..###..#
#..#......
.........#
..#...##..
....#.##.#
...##.#..#
....#...##
#..#..##..
##.#.#.#..

Tile 1747:
....##.#..
#........#
.....#..#.
..#####...
######..#.
##..#.#...
.###..#..#
#.....#...
.##..#..##
..#####...

Tile 3089:
#....#.##.
#.....#..#
..........
#..#.#....
.......#..
#.....#...
........#.
##..#..##.
#.....#..#
#.#.#....#

Tile 3019:
.#..###.##
.#...#...#
#.#.......
###.......
#....#...#
#.##...#..
##........
.#.......#
.#.#......
.#..#...#.

Tile 3079:
...#.###..
#......#..
#.......##
#...#..###
#.......#.
......#.#.
#........#
.#.#...###
..#.#....#
...#...#.#

Tile 1663:
##.##..###
#.....##.#
......#.##
#........#
..#.#.....
....#..#.#
#.#.#..#.#
#.......#.
..#......#
#.#..#....

Tile 1823:
.###...###
#.#.#..##.
..........
.........#
###....#..
..........
##....#.##
#.......##
..#..#...#
......####

Tile 3823:
....#..#..
..#.#..#.#
###.#.##.#
..##....#.
#.........
#....#...#
#.......##
#.#...##..
..#....#..
..#....##.

Tile 1901:
#.#.#....#
..#....#.#
...#..#.#.
.#..#..###
....####..
......#...
#....#....
..#....#..
#......#..
######.#..

Tile 3347:
#.#.....#.
#..#..#...
#.#.......
#..#.#....
...#......
#.........
##.#.....#
#........#
#....#...#
#.#.##.###

Tile 1873:
..###.#.##
.#.#....#.
#........#
..#..#...#
##.....#..
#........#
#.........
.#........
#.#..#.#.#
.##.#...##

Tile 2053:
#.#.#.#..#
#...###..#
##.##.##.#
....##.#.#
#.###....#
#.....#..#
#..##.####
....#..#..
#.........
#..#.#..#.

Tile 2659:
.#....##.#
#.#......#
#..#......
.#.###.#.#
..........
#........#
.......#.#
....#....#
#........#
##..##.#..

Tile 2503:
.#..####.#
#.##......
..#....###
..#..#.###
...##...##
..#.....#.
..........
##.#......
#.#.......
#...#..#.#

Tile 3881:
##.###.###
#......#..
#...#....#
..#.#....#
#..#..#..#
#..#.....#
...#..##.#
#.#.......
#..##....#
...#.##...

Tile 1973:
..#.###.#.
#.##....##
#.......##
##......##
#.........
#.#..#....
.#....###.
..#.#..#..
......#..#
#..#.....#

Tile 3329:
.#.#.###.#
..#.#.....
.#.......#
#..#.##.##
#.##..####
..#.##..##
....#.....
#...#.#.#.
...#.#...#
.#...##..#

Tile 3331:
#......###
#......#.#
#.#.#.#..#
........#.
.##.####..
#..#..#..#
.#.......#
......#.##
......#.#.
.##...#.#.

Tile 1307:
##.#.#..#.
.........#
.#....##.#
#.........
#.........
#....#.#..
........##
......##..
..#.##...#
..##...##.

Tile 2543:
.#.#.##.##
#........#
..##......
#.........
##...#...#
.###..##.#
.##......#
.#........
.....#.#..
...######.

Tile 2003:
#.#..#.#.#
.....#....
#.#.#.....
####.#..##
..###....#
....#.#...
#.####...#
.##...#.##
#.#.#..#..
...#.....#

Tile 3301:
##....##.#
.....#...#
#........#
..........
###.##.#..
.....#...#
#.#......#
....##...#
#........#
.#.#...#.#

Tile 2297:
#..#.##..#
...#.#.##.
..###..#..
##..#.....
####..#..#
..#.#..#..
.....#...#
#...#.....
#.....#..#
##....#...

Tile 2311:
##.....#.#
##........
#........#
#...##....
#......#..
.........#
.........#
#..#.#....
.....#...#
###.#..##.

Tile 1361:
.#.##.#..#
#.#..#...#
#....###..
..###.#...
#..#.....#
#..#...##.
#.#.....#.
.......#.#
##.##.....
#.###.#..#

Tile 1481:
.####.#.##
..........
.........#
###.#.#...
##....##.#
..#...#.##
..##.#.#..
#.#.....##
.......#..
....###...

Tile 1153:
.##.##..##
###......#
#....##...
......#.#.
#....#....
.....##..#
.....#...#
#.........
#...#....#
##..#.#...

Tile 2153:
#.###.#..#
..#.##....
..##....#.
##...#...#
#...#.....
........#.
#..##...#.
..#.......
#...##.#..
#.#.#.#...

Tile 2377:
.##..##.#.
...##..#.#
#.#.#.....
#.##......
#.....#..#
#...#....#
...##....#
...###....
.#.##...##
.###.##...

Tile 3863:
.##.###.##
.......#.#
#........#
##.#.#...#
##...#...#
#...##....
#..#..#.##
.....#####
##.#..###.
....###...

Tile 1163:
##..######
#........#
.#.#...###
..#..#...#
##..#...##
#.#.......
#.#..#....
#..#.#....
###..#...#
.#####.###

Tile 2207:
.#..#.#.##
##.....#.#
#..#.....#
#..#....##
.........#
...#.....#
#...#..#..
..#.....##
.....#....
#.##.....#

Tile 1201:
#.##.##..#
#.#.......
#..#.....#
.###...#..
#.#......#
........##
.........#
.##....#.#
..##.#...#
.......###

Tile 1619:
#.....#.#.
...#.##..#
#.....#...
#...#.....
#..#...#.#
#..##.#...
.#...#.#..
#......##.
#.........
#.##...###

Tile 3389:
...#..##..
#........#
#...#.....
#.#....#.#
###....#.#
#.#....###
#..##..#.#
.##.#.#..#
#...###...
#...#....#

Tile 3359:
.###..##..
#........#
###...#.#.
........##
....#..#.#
.#.#......
#........#
.......#.#
.#.....#..
##.###....
TEXT

# INPUT = <<~TEXT.split("\n")
# Tile 2311:
# ..##.#..#.
# ##..#.....
# #...##..#.
# ####.#...#
# ##.##.###.
# ##...#.###
# .#.#.#..##
# ..#....#..
# ###...#.#.
# ..###..###

# Tile 1951:
# #.##...##.
# #.####...#
# .....#..##
# #...######
# .##.#....#
# .###.#####
# ###.##.##.
# .###....#.
# ..#.#..#.#
# #...##.#..

# Tile 1171:
# ####...##.
# #..##.#..#
# ##.#..#.#.
# .###.####.
# ..###.####
# .##....##.
# .#...####.
# #.##.####.
# ####..#...
# .....##...

# Tile 1427:
# ###.##.#..
# .#..#.##..
# .#.##.#..#
# #.#.#.##.#
# ....#...##
# ...##..##.
# ...#.#####
# .#.####.#.
# ..#..###.#
# ..##.#..#.

# Tile 1489:
# ##.#.#....
# ..##...#..
# .##..##...
# ..#...#...
# #####...#.
# #..#.#.#.#
# ...#.#.#..
# ##.#...##.
# ..##.##.##
# ###.##.#..

# Tile 2473:
# #....####.
# #..#.##...
# #.##..#...
# ######.#.#
# .#...#.#.#
# .#########
# .###.#..#.
# ########.#
# ##...##.#.
# ..###.#.#.

# Tile 2971:
# ..#.#....#
# #...###...
# #.#.###...
# ##.##..#..
# .#####..##
# .#..####.#
# #..#.#..#.
# ..####.###
# ..#.#.###.
# ...#.#.#.#

# Tile 2729:
# ...#.#.#.#
# ####.#....
# ..#.#.....
# ....#..#.#
# .##..##.#.
# .#.####...
# ####.#.#..
# ##.####...
# ##..#.##..
# #.##...##.

# Tile 3079:
# #.#.#####.
# .#..######
# ..#.......
# ######....
# ####.#..#.
# .#...#.##.
# #.#####.##
# ..#.###...
# ..#.......
# ..#.###...
# TEXT

class Tile
  attr_reader :x, :y, :a, :b, :number, :image

  def initialize(image, number)
    @x = image.first.join
    @y = image.last.join
    @a = image.transpose.first.join
    @b = image.transpose.last.join
    @image = image
    @number = number
  end

  def match?(other)
    return true unless other
    !(
      [x, y, a, b].flat_map {|w| [w, w.reverse]} & [other.x, other.y, other.a, other.b].flat_map {|w| [w, w.reverse]}
    ).empty?
  end

  def hash
    [@image, @number].hash
  end

  def deep_clone
    Marshal.load(Marshal.dump(self))
  end

  def to_s
    @image.map {|u| u.map{|w| w == '#' ? '▩' : '▢'}.join}.join("\n")
  end

  def inspect
    @image.map(&:join).join("\n")
  end

  def oriented_towards(top, left)
    all_variations.select {|the_clone| [nil, the_clone.x].include?(top&.y) && [nil, the_clone.a].include?(left&.b) }
  end

  def orient_towards(top, left)
    to_perform =
      [false, true].product([false, true], [0, 90, 180, 270]).find do |vertical, horizontal, rotation|
        the_clone = deep_clone
        the_clone.reorient flip_vertical: vertical, flip_horizontal: horizontal, rotation: rotation
        [nil, the_clone.x].include?(top&.y) && [nil, the_clone.a].include?(left&.b)
      end

    if to_perform
      reorient flip_vertical: to_perform[0], flip_horizontal: to_perform[1], rotation: to_perform[2]
      self
    else
      nil
    end
  end

  def all_variations
    [false, true].product([false, true], [0, 90, 180, 270]).map do |vertical, horizontal, rotation|
      the_clone = deep_clone
      the_clone.reorient flip_vertical: vertical, flip_horizontal: horizontal, rotation: rotation
      the_clone
    end.take(8)
  end

  def reorient(flip_vertical: false, flip_horizontal: false, rotation: 0)
    if flip_vertical
      @x, @y, @a, @b = @y, @x, @a, @b
      @image = @image.reverse
    end

    if flip_horizontal
      @x, @y, @a, @b = @x, @y, @b, @a
      @image = @image.map {|w| w.reverse}
    end

    rotate rotation
  end

  def rotate(degrees)
    return true if degrees.zero?

    @image = @image.transpose
    @x = @image.first.join
    @y = @image.last.join
    @a = @image.transpose.first.join
    @b = @image.transpose.last.join

    reorient flip_horizontal: true

    rotate degrees - 90
  end
end

# 1 2 3
# 4 5 6
# 7 8 9

# 1 4 7
# 2 5 8
# 3 6 9

# 7 4 1
# 8 5 2
# 9 6 3

TILES = {}
last_tile = []
last_tile_number = nil
INPUT.each do |row|
  if row.match(/^Tile/)
    last_tile_number = row.match(/\d+/).to_s.to_i
  elsif row.strip.empty?
    TILES[last_tile_number] = Tile.new last_tile, last_tile_number
    last_tile = []
  else
    last_tile.push row.chars
  end
end
TILES[last_tile_number] = Tile.new last_tile, last_tile_number

# def find_flipping(fixed, remaining, size)
#   return fixed if remaining.empty?

#   top = fixed.size < 3 ? nil : fixed[fixed.size - 3]
#   left = (fixed.size % size).zero? ? nil : fixed.last

#   new_remaining = remaining - [remaining.first]

#   remaining.first.oriented_towards(top, left).find do |oriented|
#     find_flipping fixed + [oriented], new_remaining, size
#   end
# end

MEMO = {}
def memoed(fixed, remaining, size = 12)
  key = [fixed.map(&:hash), remaining.map(&:hash)]
  if MEMO.key?(key)
    MEMO[key]
  else
    MEMO[key] = find_with_orientation fixed, remaining, size
  end
end

def find_with_orientation(fixed, remaining, size = 12)
  puts fixed.size
  return fixed if remaining.empty?

  top = fixed.size < size ? nil : fixed[fixed.size - size]
  left = (fixed.size % size).zero? ? nil : fixed.last

  new_remaining = remaining - [remaining.first]

  remaining.find do |example|
    example.oriented_towards(top, left).find do |oriented|
      found = memoed fixed + [oriented], new_remaining, size
      return found if found
      false
    end
  end
end

arrangement = memoed [], TILES.values
p arrangement.map(&:number)
p arrangement.map(&:inspect)

# arrangement = place_next(
#   [[TILES[3881]]],
#   TILES.values - [TILES[3881]],
#   [1153, 1163, 1619].map {|x| TILES[x]},
#   12,
# )[0...-1]

# 4562 - is too high
# 2281 - is too high
# 700 - is too low
# 1490 - incorrect









